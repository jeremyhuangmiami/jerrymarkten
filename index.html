<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jerry Mark Ten</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  /* your old CSS copied exactly from your previous chatbot code */
  /* ... same as previous code ... */
</style>
</head>
<body>
<main id="chat" style="display:none;"></main>
<form id="chat-form" style="display:none;">
  <input type="text" id="user-input" placeholder="Type your message..." required />
  <button type="submit">&#x27A4;</button>
</form>
<footer>
  jeremyworld.org | jerrymarkten@jeremyworld.org | donate.jeremyworld.org<br>
  <span>AI for reference only</span>
</footer>

<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCyPk7d26WwhHM34MVbSHBMrnfSTtT213Y",
  authDomain: "jeremyworld-auth.firebaseapp.com",
  projectId: "jeremyworld-auth",
  storageBucket: "jeremyworld-auth.appspot.com",
  messagingSenderId: "830728575641",
  appId: "1:830728575641:web:3d22b3b15127f0ae93f608"
};
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

// Wait until Firebase finishes initializing
auth.onAuthStateChanged(user => {
  if(user){
    // User is signed in: show chat and initialize
    document.getElementById('chat').style.display = 'flex';
    document.getElementById('chat-form').style.display = 'flex';
    initializeChatBot();
  } else {
    // User is NOT signed in: redirect to login
    window.location.href = "https://jeremyworld.org/login.html";
  }
});

function initializeChatBot(){
  const chat = document.getElementById('chat');
  const form = document.getElementById('chat-form');
  const input = document.getElementById('user-input');
  const thinkingGifUrl = 'https://i.giphy.com/koxVXnnmaQwllyovVG.webp';
  let currentThinkingBubble = null;
  const delayMilliseconds = 1500;
  document.documentElement.style.setProperty('--loading-duration', `${delayMilliseconds/1000}s`);

  function addMessage(content, role, isThinking=false){
    const div = document.createElement('div');
    div.className = `message ${role}` + (isThinking ? ' thinking' : '');
    div.innerHTML = content;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    return div;
  }

  function showLoadingIndicatorWithGif(){
    const html = `<img src="${thinkingGifUrl}" class="thinking-gif">
                  <div class="loading-info">
                    <div class="loading-text">Gathering information from Jeremy's brain...</div>
                    <div class="loading-bar-container">
                      <div class="loading-bar"></div>
                    </div>
                  </div>`;
    currentThinkingBubble = addMessage(html,'bot',true);
  }

  addMessage("Hi, I'm Jerry. How can I help?", 'bot');

  form.addEventListener('submit', async e=>{
    e.preventDefault();
    const message = input.value.trim();
    if(!message) return;
    addMessage(message,'user');
    input.value='';
    showLoadingIndicatorWithGif();

    setTimeout(async ()=>{
      try{
        const res = await fetch('https://jerrymarkten.jeremyhuangmiami.workers.dev/',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            model:"gemma2-9b-it",
            messages:[{role:"system",content:"You are a helpful assistant."},{role:"user",content:message}],
            temperature:0.7
          })
        });
        if(!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
        const data = await res.json();
        const botResponseContent = data.choices?.[0]?.message?.content || "[Error: No reply]";
        if(currentThinkingBubble){
          currentThinkingBubble.innerHTML = botResponseContent;
          currentThinkingBubble.classList.remove('thinking');
          if(typeof MathJax!=='undefined') MathJax.typesetPromise([currentThinkingBubble]);
        }
      } catch(err){
        if(currentThinkingBubble){
          currentThinkingBubble.innerHTML = `[Error] ${err.message}`;
          currentThinkingBubble.classList.remove('thinking');
        } else {
          addMessage(`[Error] ${err.message}`,'bot');
        }
      } finally { currentThinkingBubble = null; }
    }, delayMilliseconds);
  });
}
</script>
</body>
</html>
